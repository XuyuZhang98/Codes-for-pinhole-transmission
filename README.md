# Codes-for-pinhole-transmission
Data and MATLAB code used in the article "Scattering Media as Random Micro-phase-pinhole Arrays for Incoherent Information Transmission"
# Feature Fusion Algorithm

**Author:** Xuyu Zhang

This MATLAB script implements the feature fusion reconstruction algorithm described in the manuscript. It is an interactive tool designed to recover high-quality object images from speckle patterns using a "Template Matching -> Scanning -> Fusion" pipeline.

--------------------------------------------------------------------------------
1. SYSTEM REQUIREMENTS
--------------------------------------------------------------------------------

### Software
* **MATLAB:** Version R2023a or later is recommended.
* **Required Toolboxes:**
    1.  **Image Processing Toolbox** (for `ssim`, `imbinarize`, `regionprops`)
    2.  **Computer Vision Toolbox** (Crucial for `detectSURFFeatures`, `matchFeatures`, `estimateGeometricTransform`)

### Hardware
* Standard desktop computer (Intel i5/i7 or equivalent).
* No GPU required (CPU-based processing).

--------------------------------------------------------------------------------
2. USAGE INSTRUCTIONS
--------------------------------------------------------------------------------

1.  **Run the Script:**
    Open `feature_fusion_reconstruction.m` in MATLAB and run it.

2.  **Step 1: Select Speckle Image**
    A file dialog will appear. Select the raw speckle pattern you wish to process.

3.  **Step 2: Template Selection**
    Choose one of the two strategies:
    * **A. Import from File:** Load an existing reference image (e.g., a preliminary result from autocorrelation).
    * **B. Manual Selection:** The script displays the speckle image. Draw a rectangle around a clear sub-region and press the **"Enter"** key to confirm.
    * *Note:* The script automatically preprocesses the template to remove excess background noise.

4.  **Step 3: Parameter Configuration**
    Set the scanning parameters in the dialog box:
    * **SSIM Threshold:** (Default: 0.5) Lower limit for structural similarity.
    * **Min Feature Matches:** (Default: 5) Minimum number of matched SURF points.
    * **Step Size:** (Default: 4 pixels) Scanning stride. Smaller steps yield better results but increase computation time.

5.  **Step 4: Fusion & Output**
    The script scans the image, aligns valid candidates, and fuses them.
    The final results (Raw, Template, Fused, Enhanced) will be displayed. You can choose to save the final reconstructed image.

--------------------------------------------------------------------------------
3. ALGORITHM OVERVIEW
--------------------------------------------------------------------------------

The code follows a three-stage procedure:

1.  **Template Preprocessing:** Uses Otsu's thresholding and morphological operations to intelligently crop the object from the background.

2.  **Scanning & Verification:** Performs a pixel-wise scan across the speckle pattern. A local region is accepted as a candidate only if it satisfies a dual-criterion: 
    (i) SSIM >= Threshold 
    (ii) Number of matched feature points >= Threshold.

3.  **Feature Fusion:** Uses the matched feature points to calculate a geometric similarity transformation (Translation + Rotation + Scale). All candidate regions are warped to align with the template coordinate system and then averaged to produce a noise-free reconstruction.

--------------------------------------------------------------------------------
4. LICENSE
--------------------------------------------------------------------------------
MIT License (or Apache License 2.0)


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# Speckle Pattern Generation Simulation

**Author:**Xuyu Zhang

This folder contains the MATLAB source code for generating speckle patterns used in the manuscript. The simulation models the propagation of pseudo-thermal light through a scattering medium using Fresnel diffraction integrals.

--------------------------------------------------------------------------------
1. OVERVIEW
--------------------------------------------------------------------------------
The script `speckle_generation.m` simulates a multi-stage optical system:
1.  **Light Source:** Pseudo-thermal light source generated by modulating a laser with a rotating diffuser (simulated via `Roughsurface_by_wcl`).
2.  **Object Plane:** A binary object (e.g., character '5').
3.  **Scattering Medium:** Modeled by a Phase Mask.
4.  **Detector (CCD):** Captures the intensity of the scattered field.

To mimic the low spatial coherence of the source, the final speckle pattern is obtained by averaging the intensities of `N = 2500` independent propagations with varying random source phases.

--------------------------------------------------------------------------------
2. SYSTEM REQUIREMENTS
--------------------------------------------------------------------------------
* **MATLAB:** R2020a or later.
* **Toolbox:** Parallel Computing Toolbox (Required for `gpuArray`).
* **Hardware:** An NVIDIA GPU with CUDA support is **mandatory** for this script due to the heavy computational load.
    * *Tested on:* NVIDIA GeForce RTX 3090.

--------------------------------------------------------------------------------
3. FILE LIST
--------------------------------------------------------------------------------
* `speckle_generation.m`: The main simulation script.
* `Roughsurface_by_wcl.m`: (Dependency) A helper function to generate random rough surface data for the pseudo-thermal source. *[Ensure this file is in your MATLAB path]*.
* `dataset/phasemask/*.mat`: Input phase mask data files.
* `dataset/object/*.bmp`: Input object images.

--------------------------------------------------------------------------------
4. CONFIGURATION & USAGE
--------------------------------------------------------------------------------
1.  **Path Setup:**
    Open `speckle_generation.m` and modify the paths in the "Environment Setup" section to match your local directory structure:
    ```matlab
    base_path = 'path/to/your/data/';
    ```

2.  **Parameter Adjustment:**
    * `lambda`: Wavelength of light.
    * `z1`, `z2`, `z3`: Propagation distances between planes.
    * `N`: Number of averaging iterations (Default: 2500).
    * `phasemask_list`: Array of phase mask IDs to process.

3.  **Run:**
    Execute the script in MATLAB. The progress will be printed to the Command Window.

--------------------------------------------------------------------------------
5. OUTPUT
--------------------------------------------------------------------------------
The script generates speckle patterns saved as `.bmp` images in the specified `output_dir`.
* **Naming Convention:** `speckle_[MaskID]_z2[Distance]_size[ObjectSize].bmp`

